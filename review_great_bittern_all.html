<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Great Bittern - All 129 Detections Review</title>
<link rel="stylesheet" href="../website/review.css">
<style>
body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    max-width: 1400px;
    margin: 20px auto;
    padding: 20px;
    background: #1a1a1a;
    color: #e0e0e0;
}

h1 {
    color: #4CAF50;
    border-bottom: 3px solid #4CAF50;
    padding-bottom: 15px;
}

h2 {
    color: #81C784;
    margin-top: 30px;
}

.info-box {
    background: #263238;
    border-left: 5px solid #FFA726;
    padding: 20px;
    margin: 20px 0;
    border-radius: 5px;
}

.detection-card {
    background: #2c2c2c;
    border: 2px solid #444;
    padding: 20px;
    margin: 20px 0;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.detection-card:hover {
    border-color: #4CAF50;
    box-shadow: 0 0 15px rgba(76, 175, 80, 0.3);
}

.detection-card.passed {
    background: #1B5E20;
    border-color: #4CAF50;
}

.detection-card.failed {
    background: #B71C1C;
    border-color: #F44336;
}

.detection-card img {
    max-width: 100%;
    border: 2px solid #555;
    border-radius: 5px;
    margin: 15px 0;
}

audio {
    width: 100%;
    margin: 15px 0;
}

.metadata {
    font-family: 'Courier New', monospace;
    background: #1a1a1a;
    padding: 15px;
    border-radius: 5px;
    margin: 10px 0;
    font-size: 13px;
}

.button-group {
    display: flex;
    gap: 15px;
    margin: 20px 0;
}

button {
    padding: 12px 30px;
    font-size: 16px;
    font-weight: bold;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.2s;
}

.pass-btn {
    background: #4CAF50;
    color: white;
}

.pass-btn:hover {
    background: #66BB6A;
    transform: scale(1.05);
}

.fail-btn {
    background: #F44336;
    color: white;
}

.fail-btn:hover {
    background: #EF5350;
    transform: scale(1.05);
}

.skip-btn {
    background: #757575;
    color: white;
}

.skip-btn:hover {
    background: #9E9E9E;
    transform: scale(1.05);
}

.stats {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #263238;
    padding: 20px;
    border-radius: 8px;
    border: 2px solid #4CAF50;
    min-width: 200px;
    z-index: 1000;
}

.stats h3 {
    margin-top: 0;
    color: #4CAF50;
}

.stats p {
    margin: 8px 0;
    font-size: 14px;
}

.export-btn {
    background: #2196F3;
    color: white;
    width: 100%;
    margin-top: 15px;
}

.export-btn:hover {
    background: #42A5F5;
}

.progress-bar {
    width: 100%;
    height: 25px;
    background: #1a1a1a;
    border-radius: 5px;
    overflow: hidden;
    margin: 15px 0;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #4CAF50, #81C784);
    width: 0%;
    transition: width 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 12px;
}
</style>
</head>
<body>

<h1>🦆 Great Bittern - Complete Spectrogram Review</h1>

<div class="info-box">
    <h3>📊 Review Instructions</h3>
    <p><strong>Total Detections:</strong> 75 with enhanced audio/spectrograms (from 129 total)</p>
    <p><strong>Previous Decision:</strong> You initially rejected Great Bittern, then verified it based on example #3 (87.3% confidence)</p>
    <p><strong>Current Task:</strong> Review ALL spectrograms to confirm which detections are valid Great Bittern vocalizations vs. noise</p>
    <p><strong>Your Request:</strong> "i want more great bittern. because i am not 100% convinced"</p>
    <br>
    <p><strong>What to Look For:</strong></p>
    <ul>
        <li><strong>Great Bittern "Boom":</strong> Deep, low-frequency (80-300 Hz) resonant sound, like blowing across a bottle</li>
        <li><strong>Duration:</strong> 2-3 second pulses, often in series</li>
        <li><strong>Pattern:</strong> Look for horizontal low-frequency bands in spectrogram</li>
        <li><strong>Reject:</strong> Rain noise, wind, mechanical sounds, unclear signals</li>
    </ul>
</div>

<div class="stats" id="stats">
    <h3>📈 Progress</h3>
    <div class="progress-bar">
        <div class="progress-fill" id="progressBar">0/75</div>
    </div>
    <p><strong>Reviewed:</strong> <span id="reviewed">0</span> / 75</p>
    <p><strong>Passed:</strong> <span id="passed">0</span></p>
    <p><strong>Failed:</strong> <span id="failed">0</span></p>
    <p><strong>Pass Rate:</strong> <span id="passRate">-</span></p>
    <button class="export-btn" onclick="exportResults()">💾 Export Results</button>
</div>

<hr style="border-color: #444; margin: 30px 0;">

<div id="detections-container"></div>

<script>
// Load detection data from CSV
const detectionsData = [
    // This will be populated by reading the great_bittern_available.csv
    // For now, we'll generate from the 75 spectrograms
];

// Generate detection cards from files
const spectrogramFiles = [
    "2025-10-13_11h37m_Great_Bittern_28956s_conf0322",
    "2025-10-14_00h00m_Great_Bittern_12963s_conf0312",
    "2025-10-14_00h00m_Great_Bittern_41601s_conf0451",
    "2025-10-14_00h00m_Great_Bittern_41829s_conf0273",
    "2025-10-14_00h00m_Great_Bittern_41865s_conf0431",
    "2025-10-14_00h00m_Great_Bittern_41910s_conf0913",
    "2025-10-14_00h00m_Great_Bittern_42129s_conf0441",
    "2025-10-14_00h00m_Great_Bittern_42150s_conf0904",
    "2025-10-14_00h00m_Great_Bittern_42276s_conf0250",
    "2025-10-14_00h00m_Great_Bittern_42315s_conf0287",
    "2025-10-14_00h00m_Great_Bittern_42477s_conf0263",
    "2025-10-14_00h00m_Great_Bittern_42558s_conf0390",
    "2025-10-14_00h00m_Great_Bittern_42804s_conf0461",
    "2025-10-14_00h00m_Great_Bittern_42960s_conf0285",
    "2025-10-14_00h00m_Great_Bittern_42996s_conf0409",
    "2025-10-14_00h00m_Great_Bittern_43167s_conf0254",
    "2025-10-14_00h00m_Great_Bittern_43182s_conf0357",
    "2025-10-14_00h00m_Great_Bittern_43200s_conf0330",
    "2025-10-14_00h00m_Great_Bittern_44037s_conf0307",
    "2025-10-14_00h00m_Great_Bittern_44658s_conf0293",
    "2025-10-14_00h00m_Great_Bittern_9054s_conf0259",
    "2025-10-14_12h25m_Great_Bittern_1212s_conf0483",
    "2025-10-14_12h25m_Great_Bittern_1335s_conf0328",
    "2025-10-14_12h25m_Great_Bittern_1410s_conf0425",
    "2025-10-14_12h25m_Great_Bittern_1431s_conf0443",
    "2025-10-14_12h25m_Great_Bittern_1443s_conf0384",
    "2025-10-14_12h25m_Great_Bittern_1515s_conf0499",
    "2025-10-14_12h25m_Great_Bittern_1518s_conf0340",
    "2025-10-14_12h25m_Great_Bittern_1797s_conf0397",
    "2025-10-14_12h25m_Great_Bittern_1815s_conf0457",
    "2025-10-14_12h25m_Great_Bittern_1836s_conf0382",
    "2025-10-14_12h25m_Great_Bittern_1851s_conf0469",
    "2025-10-14_12h25m_Great_Bittern_1929s_conf0267",
    "2025-10-14_12h25m_Great_Bittern_1932s_conf0362",
    "2025-10-14_12h25m_Great_Bittern_20103s_conf0322",
    "2025-10-14_12h25m_Great_Bittern_20262s_conf0380",
    "2025-10-14_12h25m_Great_Bittern_20325s_conf0263",
    "2025-10-14_12h25m_Great_Bittern_2169s_conf0452",
    "2025-10-14_12h25m_Great_Bittern_21927s_conf0279",
    "2025-10-14_12h25m_Great_Bittern_2220s_conf0445",
    "2025-10-14_12h25m_Great_Bittern_2253s_conf0327",
    "2025-10-14_12h25m_Great_Bittern_2274s_conf0436",
    "2025-10-14_12h25m_Great_Bittern_2289s_conf0366",
    "2025-10-14_12h25m_Great_Bittern_23391s_conf0297",
    "2025-10-14_12h25m_Great_Bittern_23394s_conf0469",
    "2025-10-14_12h25m_Great_Bittern_2364s_conf0484",
    "2025-10-14_12h25m_Great_Bittern_2424s_conf0470",
    "2025-10-14_12h25m_Great_Bittern_24375s_conf0368",
    "2025-10-14_12h25m_Great_Bittern_2463s_conf0383",
    "2025-10-14_12h25m_Great_Bittern_2475s_conf0344",
    "2025-10-14_12h25m_Great_Bittern_2481s_conf0316",
    "2025-10-14_12h25m_Great_Bittern_2514s_conf0429",
    "2025-10-14_12h25m_Great_Bittern_25524s_conf0294",
    "2025-10-14_12h25m_Great_Bittern_25563s_conf0331",
    "2025-10-14_12h25m_Great_Bittern_2568s_conf0459",
    "2025-10-14_12h25m_Great_Bittern_25860s_conf0282",
    "2025-10-14_12h25m_Great_Bittern_2586s_conf0253",
    "2025-10-14_12h25m_Great_Bittern_25884s_conf0316",
    "2025-10-14_12h25m_Great_Bittern_2607s_conf0269",
    "2025-10-14_12h25m_Great_Bittern_2712s_conf0405",
    "2025-10-14_12h25m_Great_Bittern_2802s_conf0491",
    "2025-10-14_12h25m_Great_Bittern_2814s_conf0305",
    "2025-10-14_12h25m_Great_Bittern_2919s_conf0482",
    "2025-10-14_12h25m_Great_Bittern_2940s_conf0365",
    "2025-10-14_12h25m_Great_Bittern_29505s_conf0291",
    "2025-10-14_12h25m_Great_Bittern_3315s_conf0873",
    "2025-10-14_12h25m_Great_Bittern_570s_conf0285",
    "2025-10-14_12h25m_Great_Bittern_600s_conf0396",
    "2025-10-15_00h00m_Great_Bittern_10287s_conf0308",
    "2025-10-15_00h00m_Great_Bittern_13023s_conf0367",
    "2025-10-15_00h00m_Great_Bittern_19194s_conf0321",
    "2025-10-15_00h00m_Great_Bittern_41007s_conf0333",
    "2025-10-15_00h00m_Great_Bittern_4281s_conf0333",
    "2025-10-15_00h00m_Great_Bittern_8166s_conf0405",
    "2025-10-15_00h00m_Great_Bittern_8175s_conf0263"
];

let reviews = JSON.parse(localStorage.getItem('great_bittern_reviews') || '[]');
if (reviews.length === 0) {
    reviews = new Array(spectrogramFiles.length).fill(null);
}

function parseFilename(filename) {
    const parts = filename.match(/(\d{4}-\d{2}-\d{2})_(\d{2})h(\d{2})m_.*_(\d+)s_conf(\d{4})/);
    if (parts) {
        const [_, date, hour, minute, seconds, conf] = parts;
        return {
            date: date,
            time: `${hour}:${minute}:00`,
            seconds: seconds,
            confidence: (parseInt(conf) / 1000).toFixed(3)
        };
    }
    return { date: '?', time: '?', seconds: '?', confidence: '?' };
}

function renderDetections() {
    const container = document.getElementById('detections-container');
    container.innerHTML = '';

    spectrogramFiles.forEach((file, idx) => {
        const meta = parseFilename(file);
        const card = document.createElement('div');
        card.className = 'detection-card';
        card.id = `detection-${idx}`;

        if (reviews[idx] === 'pass') card.classList.add('passed');
        if (reviews[idx] === 'fail') card.classList.add('failed');

        card.innerHTML = `
            <h2>Detection #${idx + 1} of ${spectrogramFiles.length}</h2>
            <div class="metadata">
                <strong>Date:</strong> ${meta.date} @ ${meta.time}<br>
                <strong>Confidence:</strong> ${(parseFloat(meta.confidence) * 100).toFixed(1)}%<br>
                <strong>Timestamp:</strong> ${meta.seconds}s into recording
            </div>

            <img src="results/spectrograms_great_bittern/${file}.png"
                 alt="Spectrogram ${idx + 1}"
                 onerror="this.style.border='2px solid red'; this.alt='⚠️ Spectrogram not found';">

            <audio controls>
                <source src="results/audio_clips_enhanced/${file}.wav" type="audio/wav">
                Your browser does not support audio playback.
            </audio>

            <div class="button-group">
                <button class="pass-btn" onclick="markDetection(${idx}, 'pass')">
                    ✅ PASS - Valid Great Bittern
                </button>
                <button class="fail-btn" onclick="markDetection(${idx}, 'fail')">
                    ❌ FAIL - Noise/Artifact
                </button>
                <button class="skip-btn" onclick="scrollToNext(${idx})">
                    ⏭️ Skip
                </button>
            </div>
        `;

        container.appendChild(card);
    });

    updateStats();
}

function markDetection(idx, result) {
    reviews[idx] = result;
    localStorage.setItem('great_bittern_reviews', JSON.stringify(reviews));

    const card = document.getElementById(`detection-${idx}`);
    card.classList.remove('passed', 'failed');
    if (result === 'pass') card.classList.add('passed');
    if (result === 'fail') card.classList.add('failed');

    updateStats();
    scrollToNext(idx);
}

function scrollToNext(currentIdx) {
    const nextIdx = currentIdx + 1;
    if (nextIdx < spectrogramFiles.length) {
        const nextCard = document.getElementById(`detection-${nextIdx}`);
        nextCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
    } else {
        alert('🎉 Review complete! Click "Export Results" to save your decisions.');
    }
}

function updateStats() {
    const reviewed = reviews.filter(r => r !== null).length;
    const passed = reviews.filter(r => r === 'pass').length;
    const failed = reviews.filter(r => r === 'fail').length;
    const total = spectrogramFiles.length;
    const passRate = reviewed > 0 ? ((passed / reviewed) * 100).toFixed(1) : '-';

    document.getElementById('reviewed').textContent = reviewed;
    document.getElementById('passed').textContent = passed;
    document.getElementById('failed').textContent = failed;
    document.getElementById('passRate').textContent = reviewed > 0 ? `${passRate}%` : '-';

    const progressBar = document.getElementById('progressBar');
    const percent = (reviewed / total) * 100;
    progressBar.style.width = `${percent}%`;
    progressBar.textContent = `${reviewed}/${total}`;
}

function exportResults() {
    let csvContent = "detection_number,filename,confidence,decision\n";
    spectrogramFiles.forEach((file, idx) => {
        const meta = parseFilename(file);
        const decision = reviews[idx] || 'not_reviewed';
        csvContent += `${idx + 1},${file},${meta.confidence},${decision}\n`;
    });

    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'great_bittern_review_results.csv';
    a.click();

    // Also log summary
    const reviewed = reviews.filter(r => r !== null).length;
    const passed = reviews.filter(r => r === 'pass').length;
    const failed = reviews.filter(r => r === 'fail').length;

    console.log(`\n=== GREAT BITTERN REVIEW RESULTS ===`);
    console.log(`Total reviewed: ${reviewed} / ${spectrogramFiles.length}`);
    console.log(`Passed: ${passed}`);
    console.log(`Failed: ${failed}`);
    console.log(`Pass rate: ${((passed / reviewed) * 100).toFixed(1)}%`);
}

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
    const currentCard = document.querySelector('.detection-card:hover') ||
                       Array.from(document.querySelectorAll('.detection-card'))
                           .find(card => {
                               const rect = card.getBoundingClientRect();
                               return rect.top >= 0 && rect.top <= window.innerHeight / 2;
                           });

    if (!currentCard) return;

    const idx = parseInt(currentCard.id.replace('detection-', ''));

    if (e.key === 'p' || e.key === 'P') {
        markDetection(idx, 'pass');
    } else if (e.key === 'f' || e.key === 'F') {
        markDetection(idx, 'fail');
    } else if (e.key === 'n' || e.key === 'N' || e.key === 'ArrowDown') {
        scrollToNext(idx);
    } else if (e.key === 'ArrowUp') {
        if (idx > 0) {
            document.getElementById(`detection-${idx - 1}`).scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    } else if (e.key === ' ') {
        e.preventDefault();
        const audio = currentCard.querySelector('audio');
        if (audio.paused) {
            audio.play();
        } else {
            audio.pause();
        }
    }
});

// Initialize
renderDetections();
</script>

<div style="margin-top: 50px; padding-top: 30px; border-top: 2px solid #444;">
    <h3>⌨️ Keyboard Shortcuts</h3>
    <ul>
        <li><strong>P</strong> - Pass current detection</li>
        <li><strong>F</strong> - Fail current detection</li>
        <li><strong>N</strong> or <strong>↓</strong> - Next detection</li>
        <li><strong>↑</strong> - Previous detection</li>
        <li><strong>Space</strong> - Play/Pause audio</li>
    </ul>
</div>

</body>
</html>
